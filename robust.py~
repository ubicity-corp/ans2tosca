#!/usr/bin/env python3
"""
ansible_argument_spec_extractor.py

General-purpose tool to extract argument_spec from any Ansible module,
including those inheriting from AnsibleModule subclasses, safely.

Outputs JSON Schema (Draft-07) for the module arguments.
"""

import os
import sys
import json
import importlib.util
import argparse
import inspect
from types import ModuleType
from typing import Dict, Any

# ----------------------------
# Helpers
# ----------------------------

def safe_import_module(path: str) -> ModuleType:
    """Import a Python module from path safely."""
    if not os.path.isfile(path):
        raise FileNotFoundError(path)
    spec = importlib.util.spec_from_file_location("__ansible_module__", path)
    module = importlib.util.module_from_spec(spec)
    spec.loader.exec_module(module)
    return module

def find_ansible_module_class(module: ModuleType):
    """
    Find class that inherits from AnsibleModule (or subclass).
    Returns the class object or None.
    """
    for name, obj in inspect.getmembers(module, inspect.isclass):
        try:
            for base in inspect.getmro(obj):
                if base.__name__ == "AnsibleModule":
                    return obj
        except Exception:
            continue
    return None

def instantiate_module_class(cls, extra_spec=None):
    """
    Instantiate the module safely, overriding exit_json/fail_json.
    """
    class DummyModule(cls):
        def __init__(self, *args, **kwargs):
            # Inject argument_spec if provided
            if extra_spec:
                kwargs["argument_spec"] = extra_spec
            super().__init__(*args, **kwargs)

        def exit_json(self, **kwargs): 
            # prevent real exit
            pass
        def fail_json(self, **kwargs): 
            # prevent real exit
            pass

    # create instance with empty args, supports_check_mode=False
    instance = DummyModule(argument_spec=extra_spec or {}, supports_check_mode=False)
    return instance

def merge_argument_spec(module):
    """
    Extract the full argument_spec for any Ansible module.
    """
    # 1. Look for top-level variable
    arg_spec = getattr(module, "argument_spec", None)
    if arg_spec and isinstance(arg_spec, dict):
        return arg_spec

    # 2. Look for a class inheriting from AnsibleModule
    cls = find_ansible_module_class(module)
    if cls:
        instance = instantiate_module_class(cls)
        return getattr(instance, "argument_spec", {})

    retu
